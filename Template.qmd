---
title: "Weekly Pass Use Comparison"
subtitle: "10.28.24 - 11.3.24 vs. 10.27.25 - 11.2.25"
theme: _brand.yml
format: html
---

```{r echo=FALSE}
#| label: libraries
#| warning: false


library(DT)
library(tidyverse)
```

```{r echo=FALSE}
#| label: data

OldWeek <- read_rds("Old.rds")
NewWeek <- read_rds("New.rds")
FullData <- rbind(OldWeek, NewWeek)
```

```{r echo=FALSE}

FullData <- FullData |>
    mutate(Visit24 = ifelse(year(Date) == 2024, 1, 0),
           Visit25 = ifelse(year(Date) == 2025, 1, 0))

```

```{r echo=FALSE}
#| label: sort facility data

SouthRec <- FullData |> 
    filter(Facility == "1")

NorthRec <- FullData |> 
    filter(Facility == "2")

BDRec <- FullData |> 
    filter(Facility == "3")

S91 <- FullData |> 
    filter(Facility == "4")

Unassigned <- FullData |> 
  filter(Facility == "5")
```

```{r echo=FALSE}
#| label: build functions for datasets

# Function to create pass comparison with totals
create_pass_comparison <- function(data) {
  # Calculate totals row
  totals <- data |>
    summarize(
      Pass_Type = "Total",
      Visits24 = sum(Visit24),
      Visits25 = sum(Visit25),
      PercentChange = case_when(
        sum(Visit24) == 0 ~ 100,
        TRUE ~ round((sum(Visit25) / sum(Visit24) - 1) * 100, digits = 1)
      )
    )
  
  # Calculate by pass type
  by_pass <- data |>
    group_by(Pass_Type) |>
    summarize(
      Visits24 = sum(Visit24),
      Visits25 = sum(Visit25),
      .groups = "drop"
    ) |>
    mutate(
      PercentChange = case_when(
        Visits24 == 0 ~ 100,
        TRUE ~ round((Visits25 / Visits24 - 1) * 100, digits = 1)
      )
    )
  
  # Combine totals and individual pass types
  bind_rows(totals, by_pass)
}

# function to create comparison plots
create_plot <- function(data, title, y_limit, subtitle = "Second Full Week of October") {
  
  # Prepare data
  plot_data <- data |> 
    mutate(Day = wday(Date, label = TRUE, abbr = FALSE),
           Year = year(Date)) |> 
    group_by(Day, Year) |> 
    summarize(TotalVisits = n(), .groups = "drop") |> 
    complete(Day = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"),
      Year,
      fill = list(TotalVisits = 0)) |> 
    mutate(Day = factor(Day, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))
  
  # Calculate averages
  mean_24 <- plot_data |>
    filter(Year == 2024) |>
    summarize(mean.visits = mean(TotalVisits)) |> 
    pull(mean.visits)
  
  mean_25 <- plot_data |>
    filter(Year == 2025) |>
    summarize(mean.visits = mean(TotalVisits)) |> 
    pull(mean.visits)
  
  # Create plot
  ggplot(plot_data, aes(x = Day, y = TotalVisits, color = factor(Year), group = Year)) +
    geom_line(linewidth = 0.8) +
    geom_point(aes(fill = factor(Year)), size = 2.3, shape = 21, color = "white", stroke = 1) +
    scale_color_manual(
      values = c("2024" = "gray70", "2025" = "#AB0520"),
      name = "Year") +
    scale_fill_manual(
      values = c("2024" = "gray70", "2025" = "#AB0520"),
      name = "Year") +
    scale_y_continuous(expand = c(0, 0), limits = c(0, y_limit)) +
    labs(
      title = title,
      subtitle = subtitle,
      x = "Day of Week",
      y = "Total Visits") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
    annotate("label", x = Inf, y = Inf, 
             label = paste("2024 Avg:", round(mean_24), "\n2025 Avg:", round(mean_25)),
             hjust = 1, vjust = 1,
             fill = "white", alpha = 0.8, size = 3,
             color = "black")
}

# function for data tables

comparison_table <- function(data, 
                                page_length = 15,
                                pct_change_col = "PercentChange",
                                total_col = "Pass_Type",
                                color_cuts = c(-25, 25),
                                color_values = c("#EF4056", "black", "#70B865")) {
  
  datatable(data, options = list(pageLength = page_length)) |>
    formatStyle(
      pct_change_col,
      color = styleInterval(
        cuts = color_cuts,
        values = color_values)) |>
    formatStyle(        
      columns = 1:ncol(data),
      target = "row",
      fontWeight = styleEqual("Total", "bold"),
      valueColumns = total_col)
}

```

```{r echo=FALSE}
#| label: create data to visualize

# apply functions to create dataset
TotalPassCompare <- create_pass_comparison(FullData)
SRECPassCompare <- create_pass_comparison(SouthRec)
NRECPassCompare <- create_pass_comparison(NorthRec)
BDRECPassCompare <- create_pass_comparison(BDRec)
S91PassCompare <- create_pass_comparison(S91)
UnassignedCompare <- create_pass_comparison(Unassigned)

TotalPlotFinal <- create_plot(FullData, "Total Pass Usage by Day of the Week", 7200)
SouthPlot <- create_plot(SouthRec, "South Rec Pass Usage by Day of the Week", 5200)
NorthPlot <- create_plot(NorthRec, "North Rec Visits by Day of the Week", 2200)
BDPlot <- create_plot(BDRec, "Bear Down Rec Pass Usage by Day of the Week", 150)
S91Plot <- create_plot(S91, "Studio 91 Pass Usage by Day of the Week", 50)
UnassignedPlot <- create_plot(Unassigned, "Unassigned Pass Usage by Day of the Week", 150)

```

## Facility Breakdown

::: {.panel-tabset}

### Total Campus

```{r echo=FALSE}
#| label: Plot total visits

print(TotalPlotFinal)
```

```{r echo=FALSE}
#| label: build datatable for all visits

comparison_table(TotalPassCompare)
```

### South Rec

```{r echo=FALSE}
#| label: Plot SREC

print(SouthPlot)
```

```{r echo=FALSE}
#| label: build datatable for SREC

comparison_table(SRECPassCompare)
```

### North Rec

```{r echo=FALSE}
#| label: Plot NREC

print(NorthPlot)
```

```{r echo=FALSE}
#| label: build NREC datatable

comparison_table(NRECPassCompare)
```

### Bear Down Rec

```{r echo=FALSE}
#| label: Plot BDREC

print(BDPlot)
```

```{r echo=FALSE}
#| label: build datatable for BDREC

comparison_table(BDRECPassCompare)
```

### Studio 91

```{r echo=FALSE}
#| label: Studio 91 plot

print(S91Plot)
```

```{r echo=FALSE}
#| label: build datatable for S91

comparison_table(S91PassCompare)
```

### Unassigned 

```{r echo=FALSE}
#| label: Unassigned plot

print(UnassignedPlot)
```

```{r echo=FALSE}
#| label: build datatable for unassigned

comparison_table(UnassignedCompare)
```

:::

<br>

**Why is there an "Unassigned" tab?**
Mostly, these are passes counted for specific classes that aren't tied to a facility. Sometimes it'll catch student passes. They're here to ensure everything is complete.

**Why is the total number of visits different from the Pass Visit Log summary in RecTrac?**
To capture all pass usage, I've included additional passes, like Group Fitness passes, and excluded CREC Employee passes. So there is some overlap between students swiping in and then checking-in to their program. I've also hard-coded a two-minute cooldown for swipes, which doesn't appear to be applied to the Pass Visit Log in RecTrac.

**Why isn't my program or pass represented in this report?**

Great question. [Email me](mailto:jcbetts@arizona.edu?subject=Weekly%20Pass%20Report%20Question(s)) and we'll work to get it added!

